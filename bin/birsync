#!/usr/bin/env bash
watcheddir=$1
rsyncdest=$2
rsync_opts=( "-av" "--delete" "--quiet" )

sync () {
    date "+%H:%M:%S:%3N Syncing..."
    /usr/bin/rsync "${rsync_opts[@]}" --exclude=**/.* --exclude=**/*.tmp $watcheddir $rsyncdest
}

watcher () {
    if /usr/bin/inotifywait -qq -r -e CREATE,DELETE,MODIFY --excludei '^\..*\*.tmp*$' "$watcheddir"; then
        sync &
    fi
}

while watcher; do
    :
done

